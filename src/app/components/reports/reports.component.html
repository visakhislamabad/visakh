<div class="reports-container">
  <h1>Reports & Accounts</h1>

  <!-- Date Range Filter -->
  <div class="filter-section">
    <div class="date-filters">
      <div class="form-group">
        <label>Start Date:</label>
        <input type="date" [value]="startDate" (input)="startDate = $any($event.target).value" />
      </div>
      <div class="form-group">
        <label>End Date:</label>
        <input type="date" [value]="endDate" (input)="endDate = $any($event.target).value" />
      </div>
      <button class="btn btn-primary" (click)="loadReports()">Apply Filter</button>
      <button class="btn btn-success" (click)="openManualSaleModal()">â• Add Manual Sale</button>
      <button class="btn btn-export" (click)="exportToPDF()">ğŸ“„ Export to PDF</button>
      <button *ngIf="isSuperAdmin" class="btn btn-danger" (click)="clearRecords()">ğŸ—‘ï¸ Clear Records</button>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="summary-cards">
    <div class="summary-card revenue">
      <div class="card-icon">ğŸ’°</div>
      <div class="card-content">
        <h3>Total Revenue</h3>
        <p class="card-value">{{ totalRevenue.toFixed(0) }} PKR</p>
        <small>{{ totalOrdersCount }} orders</small>
      </div>
    </div>
    <div class="summary-card cash">
      <div class="card-icon">ğŸ’µ</div>
      <div class="card-content">
        <h3>Cash Revenue</h3>
        <p class="card-value">{{ cashRevenue.toFixed(0) }} PKR</p>
        <small>Cash payments</small>
      </div>
    </div>
    <div class="summary-card bank">
      <div class="card-icon">ğŸ¦</div>
      <div class="card-content">
        <h3>Bank Transfer</h3>
        <p class="card-value">{{ bankTransferRevenue.toFixed(0) }} PKR</p>
        <small>Bank transfers</small>
      </div>
    </div>
    <div class="summary-card credit">
      <div class="card-icon">ğŸ“</div>
      <div class="card-content">
        <h3>Credit Account</h3>
        <p class="card-value">{{ creditAccountRevenue.toFixed(0) }} PKR</p>
        <small>Posted to accounts</small>
      </div>
    </div>
    <div class="summary-card cash">
      <div class="card-icon">ğŸ“¥</div>
      <div class="card-content">
        <h3>Collections (Cash)</h3>
        <p class="card-value">{{ paymentsCashTotal.toFixed(0) }} PKR</p>
        <small>Customer payments</small>
      </div>
    </div>
    <div class="summary-card bank">
      <div class="card-icon">ğŸ“¥</div>
      <div class="card-content">
        <h3>Collections (Bank)</h3>
        <p class="card-value">{{ paymentsBankTotal.toFixed(0) }} PKR</p>
        <small>Customer payments</small>
      </div>
    </div>
    <div class="summary-card expenses">
      <div class="card-icon">ğŸ“Š</div>
      <div class="card-content">
        <h3>Total Expenses</h3>
        <p class="card-value">{{ totalExpenses.toFixed(0) }} PKR</p>
        <small>{{ expenses.length }} purchases</small>
      </div>
    </div>
    <div class="summary-card profit" [class.negative]="profit < 0">
      <div class="card-icon">{{ profit >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰' }}</div>
      <div class="card-content">
        <h3>Profit/Loss</h3>
        <p class="card-value">{{ profit.toFixed(0) }} PKR</p>
        <small>Revenue - Expenses</small>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button [class.active]="activeTab === 'sales'" (click)="switchTab('sales')">Sales Report</button>
    <button [class.active]="activeTab === 'expenses'" (click)="switchTab('expenses')">Expense Report</button>
    <button [class.active]="activeTab === 'items'" (click)="switchTab('items')">Item Performance</button>
    <button *ngIf="isSuperAdmin" [class.active]="activeTab === 'archives'" (click)="switchTab('archives')">ğŸ“¦ Archives</button>
  </div>

  <!-- Sales Report Tab -->
  <div *ngIf="activeTab === 'sales'" class="tab-content">
    <h2>Sales Details</h2>
    <table class="data-table">
      <thead>
        <tr>
          <th>Order #</th>
          <th>Date</th>
          <th>Table/Type</th>
          <th>Items</th>
          <th>Payment</th>
          <th>Amount</th>
          <th class="actions-col">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of salesOrders">
          <td>
            {{ order.orderNumber }}
            <span *ngIf="order.editedAt" style="color: #ff9800; font-size: 0.85em; margin-left: 4px;" title="Bill was edited on {{ formatDate(order.editedAt) }} by {{ order.editedBy }}">âœï¸</span>
          </td>
          <td>{{ formatDate(order.createdAt) }}</td>
          <td>{{ order.isTakeaway ? 'Takeaway' : 'Table ' + order.tableNumber }}</td>
          <td>{{ order.items.length }} items</td>
          <td>
            <span class="payment-badge" [class.cash]="order.paymentMethod === 'cash' || !order.paymentMethod" 
                  [class.bank]="order.paymentMethod === 'bank_transfer'"
                  [class.credit]="order.paymentMethod === 'credit_account'">
              {{ order.paymentMethod === 'bank_transfer' ? 'ğŸ¦ Bank' : 
                 order.paymentMethod === 'credit_account' ? 'ğŸ“ Credit' : 'ğŸ’µ Cash' }}
            </span>
          </td>
          <td>{{ order.totalAmount.toFixed(0) }} PKR</td>
          <td class="actions-col">
            <button class="btn-view-detail-text" (click)="viewOrderDetail(order)">
              View Details
            </button>
            <button class="btn-edit-text" (click)="openEditBillModal(order)" style="margin-left: 8px;">
              âœï¸ Edit Bill
            </button>
          </td>
        </tr>
        <tr *ngIf="salesOrders.length === 0">
          <td colspan="6" class="no-data">No sales in this period</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Expense Report Tab -->
  <div *ngIf="activeTab === 'expenses'" class="tab-content">
    <h2>Expense Details</h2>
    <table class="data-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Supplier</th>
          <th>Item</th>
          <th>Quantity</th>
          <th>Cost</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let expense of expenses">
          <td>{{ expense.date | date:'short' }}</td>
          <td>{{ expense.supplierName }}</td>
          <td>{{ expense.inventoryItemName }}</td>
          <td>{{ expense.quantity }} {{ expense.unit }}</td>
          <td>{{ expense.totalCost.toFixed(0) }}</td>
        </tr>
        <tr *ngIf="expenses.length === 0">
          <td colspan="5" class="no-data">No expenses in this period</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Item Performance Tab -->
  <div *ngIf="activeTab === 'items'" class="tab-content">
    <h2>Best Selling Items</h2>
    <table class="data-table">
      <thead>
        <tr>
          <th>Rank</th>
          <th>Item Name</th>
          <th>Quantity Sold</th>
          <th>Total Revenue</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of itemPerformance; let i = index">
          <td>{{ i + 1 }}</td>
          <td>{{ item.name }}</td>
          <td>{{ item.sold }}</td>
          <td>{{ item.revenue.toFixed(0) }}</td>
        </tr>
        <tr *ngIf="itemPerformance.length === 0">
          <td colspan="4" class="no-data">No sales data available</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Archives Tab -->
  <div *ngIf="activeTab === 'archives'" class="tab-content">
    <h2>Archived Records</h2>
    
    <!-- Archived Orders -->
    <h3 style="margin-top: 20px;">Archived Sales Orders ({{ archivedOrders.length }})</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>Order #</th>
          <th>Date</th>
          <th>Table/Type</th>
          <th>Items</th>
          <th>Payment</th>
          <th>Amount</th>
          <th>Archived Date</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let order of archivedOrders">
          <td>{{ order.orderNumber }}</td>
          <td>{{ formatDate(order.createdAt) }}</td>
          <td>{{ order.isTakeaway ? 'Takeaway' : 'Table ' + order.tableNumber }}</td>
          <td>{{ order.items.length }} items</td>
          <td>
            <span class="payment-badge" [class.cash]="order.paymentMethod === 'cash' || !order.paymentMethod" 
                  [class.bank]="order.paymentMethod === 'bank_transfer'"
                  [class.credit]="order.paymentMethod === 'credit_account'">
              {{ order.paymentMethod === 'bank_transfer' ? 'ğŸ¦ Bank' : 
                 order.paymentMethod === 'credit_account' ? 'ğŸ“ Credit' : 'ğŸ’µ Cash' }}
            </span>
          </td>
          <td>{{ order.totalAmount.toFixed(0) }} PKR</td>
          <td>{{ formatDate($any(order).archivedAt) }}</td>
        </tr>
        <tr *ngIf="archivedOrders.length === 0">
          <td colspan="7" class="no-data">No archived sales orders</td>
        </tr>
      </tbody>
    </table>

    <!-- Archived Expenses -->
    <h3 style="margin-top: 30px;">Archived Expenses ({{ archivedExpenses.length }})</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Supplier</th>
          <th>Item</th>
          <th>Quantity</th>
          <th>Cost</th>
          <th>Archived Date</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let expense of archivedExpenses">
          <td>{{ expense.date | date:'short' }}</td>
          <td>{{ expense.supplierName }}</td>
          <td>{{ expense.inventoryItemName }}</td>
          <td>{{ expense.quantity }} {{ expense.unit }}</td>
          <td>{{ expense.totalCost.toFixed(0) }}</td>
          <td>{{ formatDate($any(expense).archivedAt) }}</td>
        </tr>
        <tr *ngIf="archivedExpenses.length === 0">
          <td colspan="6" class="no-data">No archived expenses</td>
        </tr>
      </tbody>
    </table>

    <!-- Archived Customer Payments -->
    <h3 style="margin-top: 30px;">Archived Customer Payments ({{ archivedPayments.length }})</h3>
    <table class="data-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Customer</th>
          <th>Amount</th>
          <th>Payment Mode</th>
          <th>Archived Date</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let payment of archivedPayments">
          <td>{{ formatDate(payment.date) }}</td>
          <td>{{ payment.customerName }}</td>
          <td>{{ payment.amount?.toFixed(0) }} PKR</td>
          <td>
            <span class="payment-badge" [class.cash]="payment.paymentMode === 'cash'" 
                  [class.bank]="payment.paymentMode === 'bank_transfer'"
                  [class.credit]="payment.paymentMode === 'check'">
              {{ payment.paymentMode === 'cash' ? 'ğŸ’µ Cash' : 
                 payment.paymentMode === 'bank_transfer' ? 'ğŸ¦ Bank' : 'ğŸ“ Check' }}
            </span>
          </td>
          <td>{{ formatDate($any(payment).archivedAt) }}</td>
        </tr>
        <tr *ngIf="archivedPayments.length === 0">
          <td colspan="5" class="no-data">No archived customer payments</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Manual Sale Entry Modal -->
<div class="modal-overlay" *ngIf="showManualSaleModal" (click)="closeManualSaleModal()">
  <div class="modal-content manual-sale-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Add Manual Sale Record</h2>
      <button class="close-btn" (click)="closeManualSaleModal()">Ã—</button>
    </div>
    
    <div class="modal-body">
      <p class="help-text">
        Use this form to record sales that occurred when the system was unavailable.
        Enter the date/time, items, and payment details.
      </p>
      
      <!-- Sale Date and Time -->
      <div class="form-row">
        <div class="form-group">
          <label>Sale Date: *</label>
          <input type="date" [(ngModel)]="manualSale.date" required />
        </div>
        <div class="form-group">
          <label>Sale Time: *</label>
          <input type="time" [(ngModel)]="manualSale.time" required />
        </div>
      </div>

      <!-- Order Type -->
      <div class="form-row">
        <div class="form-group">
          <label>Order Type: *</label>
          <select [(ngModel)]="manualSale.isTakeaway">
            <option [value]="true">Takeaway</option>
            <option [value]="false">Dine-in</option>
          </select>
        </div>
        <div class="form-group" *ngIf="!manualSale.isTakeaway">
          <label>Table Number:</label>
          <input type="text" [(ngModel)]="manualSale.tableNumber" placeholder="e.g., T-5" />
        </div>
      </div>

      <!-- Customer Name -->
      <div class="form-group">
        <label>Customer Name: (Optional)</label>
        <input type="text" [(ngModel)]="manualSale.customerName" placeholder="Enter customer name" />
      </div>

      <!-- Items Section -->
      <div class="items-section">
        <h3>Sale Items</h3>
        <div class="item-entry" *ngFor="let item of manualSale.items; let i = index">
          <div class="form-row">
            <div class="form-group flex-2">
              <label>Item Name: *</label>
              <input type="text" [(ngModel)]="item.name" placeholder="e.g., Breakfast" required />
            </div>
            <div class="form-group flex-1">
              <label>Quantity: *</label>
              <input type="number" [(ngModel)]="item.quantity" min="1" (input)="calculateManualItemTotal(i)" required />
            </div>
            <div class="form-group flex-1">
              <label>Price: *</label>
              <input type="number" [(ngModel)]="item.price" min="0" step="0.01" (input)="calculateManualItemTotal(i)" required />
            </div>
            <div class="form-group flex-1">
              <label>Total:</label>
              <input type="number" [(ngModel)]="item.total" readonly />
            </div>
            <div class="form-group-btn">
              <button class="btn-remove" (click)="removeManualItem(i)" *ngIf="manualSale.items.length > 1">ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>
        <button class="btn btn-secondary" (click)="addManualItem()">â• Add Item</button>
      </div>

      <!-- Tax and Discount -->
      <div class="form-row">
        <div class="form-group">
          <label>Tax Rate (%):</label>
          <input type="number" [(ngModel)]="manualSale.taxRate" min="0" max="100" step="0.1" (input)="calculateManualTotals()" />
        </div>
        <div class="form-group">
          <label>Discount Amount:</label>
          <input type="number" [(ngModel)]="manualSale.discount" min="0" step="0.01" (input)="calculateManualTotals()" />
        </div>
      </div>

      <!-- Totals Display -->
      <div class="totals-section">
        <div class="total-row">
          <span>Subtotal:</span>
          <span class="total-value">{{ manualSale.subtotal.toFixed(2) }} PKR</span>
        </div>
        <div class="total-row">
          <span>Tax ({{ manualSale.taxRate }}%):</span>
          <span class="total-value">{{ manualSale.tax.toFixed(2) }} PKR</span>
        </div>
        <div class="total-row" *ngIf="manualSale.discount > 0">
          <span>Discount:</span>
          <span class="total-value">-{{ manualSale.discount.toFixed(2) }} PKR</span>
        </div>
        <div class="total-row total-final">
          <span>Total Amount:</span>
          <span class="total-value">{{ manualSale.totalAmount.toFixed(2) }} PKR</span>
        </div>
      </div>

      <!-- Payment Method -->
      <div class="form-group">
        <label>Payment Method: *</label>
        <select [(ngModel)]="manualSale.paymentMethod">
          <option value="cash">ğŸ’µ Cash</option>
          <option value="bank_transfer">ğŸ¦ Bank Transfer</option>
          <option value="credit_account">ğŸ“ Credit Account</option>
        </select>
      </div>

      <!-- Notes -->
      <div class="form-group">
        <label>Notes: (Optional)</label>
        <textarea [(ngModel)]="manualSale.notes" rows="3" placeholder="Any additional notes about this sale..."></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeManualSaleModal()">Cancel</button>
      <button class="btn btn-success" (click)="saveManualSale()" [disabled]="!isManualSaleValid()">
        ğŸ’¾ Save Sale Record
      </button>
    </div>
  </div>
</div>

<!-- Edit Bill Modal -->
<div class="modal-overlay" *ngIf="showEditBillModal" (click)="closeEditBillModal()">
  <div class="modal-content edit-bill-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Edit Bill - {{ editBillOrder?.orderNumber }}</h2>
      <button class="close-btn" (click)="closeEditBillModal()">Ã—</button>
    </div>
    
    <div class="modal-body">
      <div class="bill-edit-section" *ngIf="editBillOrder">
        <!-- Bill Header Info -->
        <div class="bill-header-info">
          <p><strong>Order:</strong> {{ editBillOrder.orderNumber }}</p>
          <p><strong>Original Date:</strong> {{ formatDate(editBillOrder.createdAt) }}</p>
          <p *ngIf="editBillOrder.editedAt" style="font-style: italic; font-size: 0.9em; color: #666;"><strong>Last Edited:</strong> {{ formatDate(editBillOrder.editedAt) }} by {{ editBillOrder.editedBy }}</p>
          <p><strong>Type:</strong> {{ editBillOrder.isTakeaway ? 'Takeaway' : 'Table ' + editBillOrder.tableNumber }}</p>
          <p *ngIf="editBillOrder.customerName"><strong>Customer:</strong> {{ editBillOrder.customerName }}</p>
        </div>

        <!-- Items Section -->
        <div class="items-section">
          <h3>Bill Items</h3>
          <div class="bill-items-list">
            <div class="bill-item-row" *ngFor="let item of editBillItems; let i = index">
              <div class="item-controls">
                <select [(ngModel)]="item.menuItemId" (change)="selectMenuItem(i, $any($event.target).value)" class="item-select">
                  <option value="">-- Select Item --</option>
                  <option *ngFor="let menu of allMenuItems" [value]="menu.id">
                    {{ menu.name }} ({{ menu.price }} PKR)
                  </option>
                </select>
                <input type="number" [(ngModel)]="item.quantity" (change)="updateItemQuantity(i)" min="1" class="qty-input" placeholder="Qty" />
                <input type="number" [(ngModel)]="item.price" (change)="updateItemQuantity(i)" min="0" class="price-input" placeholder="Price" />
                <span class="item-total">= {{ item.totalPrice.toFixed(0) }} PKR</span>
                <button class="btn-remove" (click)="removeItemFromBill(i)" [disabled]="editBillItems.length <= 1">ğŸ—‘ï¸</button>
              </div>
            </div>
          </div>
          <button class="btn btn-sm btn-secondary" (click)="addItemToBill()" style="margin-top: 10px;">
            â• Add Item
          </button>
        </div>

        <!-- Totals Section -->
        <div class="bill-totals">
          <div class="total-row">
            <span>Subtotal:</span>
            <span>{{ editBillOrder.subtotal.toFixed(0) }} PKR</span>
          </div>
          <div class="total-row">
            <span>Tax:</span>
            <span>{{ editBillOrder.tax.toFixed(0) }} PKR</span>
          </div>
          <div class="total-row" *ngIf="editBillOrder.discount > 0">
            <span>Discount:</span>
            <span>-{{ editBillOrder.discount.toFixed(0) }} PKR</span>
          </div>
          <div class="total-row total-final">
            <span>Total:</span>
            <span>{{ editBillOrder.totalAmount.toFixed(0) }} PKR</span>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeEditBillModal()">Cancel</button>
      <button class="btn btn-success" (click)="saveAndPrintBill()">
        ğŸ’¾ Save & Print Bill
      </button>
    </div>
  </div>
</div>
