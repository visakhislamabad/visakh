<div class="menu-container">
  <div class="header">
    <h1>Menu Management</h1>
    <div class="header-actions">
      <button class="btn btn-info" (click)="openCategoryModal()">üè∑Ô∏è Manage Categories</button>
      <button class="btn btn-success" (click)="exportToExcel()">üìä Export to Excel</button>
      <button class="btn btn-primary" (click)="openAddModal()">+ Add New Menu Item</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-group">
      <label>Category:</label>
      <select [(ngModel)]="selectedCategory" (change)="onCategoryChange()">
        <option value="all">All Categories</option>
        <option *ngFor="let cat of categories" [value]="cat.name">{{ cat.name }}</option>
      </select>
    </div>
    
    <div class="filter-group">
      <label>Search:</label>
      <input 
        type="text" 
        [(ngModel)]="searchText" 
        (input)="onSearchChange()" 
        placeholder="Search menu items..."
      />
    </div>
  </div>

  <!-- Menu Items Table -->
  <div class="table-container">
    <table class="items-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Category</th>
          <th>Price</th>
          <th>Tax Rate</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of filteredItems">
          <td>{{ item.name }}</td>
          <td><span class="category-badge">{{ item.category }}</span></td>
          <td>{{ item.price.toFixed(0) }}</td>
          <td>{{ item.taxRate }}%</td>
          <td>
            <span class="status-badge" [class.active]="item.isActive" [class.inactive]="!item.isActive">
              {{ item.isActive ? 'Active' : 'Inactive' }}
            </span>
          </td>
          <td class="actions">
            <button class="btn btn-sm btn-edit" (click)="openEditModal(item)">Edit</button>
            <button class="btn btn-sm btn-toggle" (click)="toggleActive(item)">
              {{ item.isActive ? 'Deactivate' : 'Activate' }}
            </button>
            <button class="btn btn-sm btn-delete" (click)="deleteItem(item)">Delete</button>
          </td>
        </tr>
        <tr *ngIf="filteredItems.length === 0">
          <td colspan="6" class="no-data">No menu items found</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal" *ngIf="showAddModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>{{ isEditMode ? 'Edit' : 'Add New' }} Menu Item</h2>
        <button class="close-btn" (click)="closeModal()">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="form-group">
          <label>Item Name *</label>
          <input type="text" [(ngModel)]="currentItem.name" placeholder="e.g., Chicken Kebab" />
        </div>

        <div class="form-group">
          <label>Category *</label>
          <select [(ngModel)]="currentItem.category">
            <option *ngFor="let cat of categories" [value]="cat.name">{{ cat.name }}</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Selling Price (PKR) *</label>
            <input type="number" [(ngModel)]="currentItem.price" min="0" step="0.01" />
          </div>

          <div class="form-group">
            <label>Tax Rate (%) *</label>
            <input type="number" [(ngModel)]="currentItem.taxRate" min="0" max="100" step="0.1" />
          </div>
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="currentItem.description" rows="3" placeholder="Optional description"></textarea>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="currentItem.soldByWeight" />
            Sold by weight (allows decimal quantities like 0.72 kg)
          </label>
        </div>

        <div class="form-group" *ngIf="currentItem.soldByWeight">
          <label>Unit</label>
          <input type="text" [(ngModel)]="currentItem.unit" placeholder="e.g., kg" />
          <small>Enter the unit of measurement (e.g., kg for kilograms)</small>
        </div>

        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="currentItem.isActive" />
            Active (visible in POS)
          </label>
        </div>

        <!-- Recipe Mapping Section -->
        <div class="recipe-section">
          <div class="recipe-header">
            <h3>Recipe Mapping (Inventory Deduction)</h3>
            <button type="button" class="btn btn-sm btn-add" (click)="addRecipeItem()">+ Add Ingredient</button>
          </div>
          <p class="help-text">Define which inventory items are consumed when this menu item is sold</p>
          
          <div class="recipe-list" *ngIf="currentItem.recipeMapping && currentItem.recipeMapping.length > 0">
            <div class="recipe-item" *ngFor="let recipe of currentItem.recipeMapping; let i = index">
              <div class="recipe-row">
                <div class="recipe-field">
                  <label>Inventory Item</label>
                  <select [(ngModel)]="recipe.inventoryItemId" (change)="onInventorySelect(recipe, $event)">
                    <option value="">Select item...</option>
                    <option *ngFor="let inv of inventoryItems" [value]="inv.id">
                      {{ inv.name }} ({{ inv.currentStock }} {{ inv.unit }})
                    </option>
                  </select>
                </div>
                
                <div class="recipe-field">
                  <label>Quantity Used</label>
                  <input type="number" [(ngModel)]="recipe.quantityUsed" min="0" step="0.01" placeholder="e.g., 1.5" />
                </div>
                
                <div class="recipe-field">
                  <label>Unit</label>
                  <input type="text" [(ngModel)]="recipe.unit" placeholder="e.g., kg" readonly />
                </div>
                
                <div class="recipe-actions">
                  <button type="button" class="btn btn-sm btn-delete" (click)="removeRecipeItem(i)">Remove</button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="no-recipe" *ngIf="!currentItem.recipeMapping || currentItem.recipeMapping.length === 0">
            <p>No ingredients added yet. Click "Add Ingredient" to map inventory items.</p>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
        <button class="btn btn-primary" (click)="saveItem()" [disabled]="isLoading">
          {{ isLoading ? 'Saving...' : 'Save' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Category Management Modal -->
  <div class="modal" *ngIf="showCategoryModal">
    <div class="modal-content modal-large">
      <div class="modal-header">
        <h2>Manage Categories</h2>
        <button class="close-btn" (click)="closeCategoryModal()">&times;</button>
      </div>
      
      <div class="modal-body category-management-body">
        <!-- Left side: Form -->
        <div class="category-form-section">
          <h3>{{ isCategoryEditMode ? 'Edit' : 'Add New' }} Category</h3>
          
          <div class="form-group">
            <label>Category Name *</label>
            <input type="text" [(ngModel)]="currentCategory.name" placeholder="e.g., Appetizers, Main Course" />
          </div>

          <div class="form-group">
            <label>Display Order</label>
            <input type="number" [(ngModel)]="currentCategory.displayOrder" min="0" placeholder="Order in dropdown" />
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="currentCategory.isActive" />
              Active
            </label>
          </div>

          <div class="form-actions">
            <button class="btn btn-secondary" (click)="resetCategoryForm()">Reset</button>
            <button class="btn btn-primary" (click)="saveCategory()" [disabled]="isLoading">
              {{ isLoading ? 'Saving...' : (isCategoryEditMode ? 'Update' : 'Add') }}
            </button>
          </div>
        </div>

        <!-- Right side: Existing Categories List -->
        <div class="categories-list-section">
          <h3>Existing Categories ({{ categories.length }})</h3>
          
          <div class="categories-grid" *ngIf="categories.length > 0">
            <div class="category-card" *ngFor="let cat of categories">
              <div class="category-info">
                <span class="category-name">{{ cat.name }}</span>
                <span class="category-order">Order: {{ cat.displayOrder }}</span>
                <span class="category-status" [class.active]="cat.isActive" [class.inactive]="!cat.isActive">
                  {{ cat.isActive ? 'Active' : 'Inactive' }}
                </span>
              </div>
              <div class="category-actions">
                <button class="btn btn-sm btn-edit" (click)="openEditCategoryModal(cat)">Edit</button>
                <button class="btn btn-sm btn-toggle" (click)="toggleCategoryActive(cat)">
                  {{ cat.isActive ? 'Deactivate' : 'Activate' }}
                </button>
                <button class="btn btn-sm btn-delete" (click)="deleteCategory(cat)">Delete</button>
              </div>
            </div>
          </div>

          <div class="no-categories" *ngIf="categories.length === 0">
            <p>No categories yet. Add your first category!</p>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCategoryModal()">Close</button>
      </div>
    </div>
  </div>
</div>
