<div class="pos-container">
  <div class="left-panel">
    <h2>Menu</h2>
    
    <!-- Category Filter -->
    <div class="category-tabs">
      <button 
        [class.active]="selectedCategory === 'all'"
        (click)="selectedCategory = 'all'; onCategoryChange()"
        class="category-tab"
      >
        All
      </button>
      <button 
        *ngFor="let cat of categories" 
        [class.active]="selectedCategory === cat.name"
        (click)="selectedCategory = cat.name; onCategoryChange()"
        class="category-tab"
      >
        {{ cat.name }}
      </button>
      <span *ngIf="categories.length === 0" class="no-categories-hint">
        (No categories - Add them in Menu Management)
      </span>
    </div>

    <!-- Search -->
    <div class="search-box">
      <input 
        type="text" 
        [(ngModel)]="searchText" 
        (input)="onSearchChange()" 
        placeholder="üîç Search menu items..."
      />
    </div>

    <!-- Menu Items Grid -->
    <div class="menu-grid">
      <div 
        *ngFor="let item of filteredMenuItems" 
        class="menu-item-card"
        (click)="addToCart(item)"
      >
        <div class="item-name">{{ item.name }}</div>
        <div class="item-price">{{ item.price.toFixed(0) }}</div>
        <div class="item-category">{{ item.category }}</div>
      </div>
      
      <div *ngIf="filteredMenuItems.length === 0" class="no-items">
        No items found
      </div>
    </div>

    <!-- Deals Section -->
    <div class="deals-section" *ngIf="activeDeals.length > 0">
      <h3>üí• Special Deals</h3>
      <div class="deals-grid">
        <div 
          *ngFor="let deal of activeDeals" 
          class="deal-card"
          (click)="addDealToCart(deal)"
        >
          <div class="deal-name">{{ deal.name }}</div>
          <div class="deal-price">
            <span class="deal-price-current">{{ deal.dealPrice.toFixed(0) }}</span>
            <span class="deal-price-original">{{ deal.originalPrice.toFixed(0) }}</span>
          </div>
          <div class="deal-savings">Save {{ deal.savingsPercent.toFixed(0) }}%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="right-panel">
    <h2>Current Order</h2>

    <!-- Order Details -->
    <div class="order-details">
      <div class="detail-row">
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="isTakeaway" />
          Takeaway
        </label>
      </div>

      <div class="detail-row" *ngIf="!isTakeaway">
        <label>Table Number:</label>
        <div class="table-selector">
          <select [(ngModel)]="tableNumber" class="table-dropdown">
            <option [ngValue]="''" disabled>Select table</option>
            <option *ngFor="let t of availableTables" [ngValue]="t">Table {{ t }}</option>
          </select>
          <button class="refresh-availability-btn" (click)="loadAvailableTables()" title="Refresh available tables">
            ‚Üª
          </button>
        </div>
        <span *ngIf="availableTables.length === 0" class="empty">No tables available</span>
      </div>

      <div class="detail-row">
        <label>Customer Name (Optional):</label>
        <input type="text" [(ngModel)]="customerName" placeholder="Customer name" />
      </div>
    </div>

    <!-- Cart Items -->
    <div class="cart-items">
      <div *ngFor="let item of cart" class="cart-item">
        <div class="item-info">
          <div class="item-name">{{ item.menuItemName }}</div>
          <div class="item-price">{{ item.price.toFixed(0) }}</div>
        </div>
        <div class="item-controls">
          <button class="qty-btn" (click)="decreaseQuantity(item)">-</button>
          <span class="quantity">{{ item.quantity }}</span>
          <button class="qty-btn" (click)="increaseQuantity(item)">+</button>
          <span class="item-total">{{ item.totalPrice.toFixed(0) }}</span>
          <button class="remove-btn" (click)="removeFromCart(item)">√ó</button>
        </div>
      </div>

      <div *ngIf="cart.length === 0" class="empty-cart">
        Cart is empty. Add items from the menu.
      </div>
    </div>

    <!-- Payment Section -->
    <div class="payment-section">
      <div class="payment-row">
        <span>Subtotal:</span>
        <span>{{ getSubtotal().toFixed(0) }}</span>
      </div>
      <div class="payment-row">
        <span>Tax:</span>
        <span>{{ getTax().toFixed(0) }}</span>
      </div>
      <div class="payment-row">
        <span>Discount:</span>
        <input 
          type="number" 
          [(ngModel)]="discount" 
          min="0" 
          step="0.01" 
          class="discount-input"
        />
      </div>
      <div class="payment-row total">
        <span>Total:</span>
        <span>{{ getTotal().toFixed(0) }}</span>
      </div>
      
      <!-- Payment Method Selection -->
      <div class="payment-method-section">
        <label class="payment-method-label">Payment Method:</label>
        <div class="payment-method-options">
          <label class="payment-option">
            <input type="radio" name="paymentMethod" value="cash" [(ngModel)]="paymentMethod" />
            <span>üíµ Cash</span>
          </label>
          <label class="payment-option">
            <input type="radio" name="paymentMethod" value="bank_transfer" [(ngModel)]="paymentMethod" />
            <span>üè¶ Bank Transfer</span>
          </label>
        </div>
      </div>
      
      <!-- POS Action Buttons moved above Bill Requests -->
      <div class="action-buttons">
        <button class="btn btn-secondary" (click)="cancelOrder()" [disabled]="cart.length === 0">Cancel</button>
        <button class="btn btn-info" (click)="printKOT()" [disabled]="cart.length === 0 || isLoading">Print KOT</button>
        <button class="btn btn-warning" (click)="openCreditCustomerSelectionForNewOrder()" [disabled]="cart.length === 0 || isLoading">Post to Account</button>
        <button class="btn btn-primary" (click)="payAndPrint()" [disabled]="cart.length === 0 || isLoading">Pay & Print Bill</button>
      </div>
    </div>

    <!-- Bill Requests (Waiter -> Cashier) -->
    <div class="bill-requests">
      <div class="bill-requests-header">
        <h2>Bill Requests</h2>
        <div class="header-actions">
          <button class="refresh-btn" (click)="loadReadyOrders()" [disabled]="isRefreshing">
            <span class="mini-spinner" *ngIf="isRefreshing"></span>
            <span>‚Üª Refresh</span>
          </button>
          <button class="sound-toggle" (click)="toggleSound()">üîî {{ soundEnabled ? 'Sound On' : 'Sound Off' }}</button>
        </div>
      </div>
      <div *ngIf="readyOrders.length === 0" class="empty">No bill requests</div>
      <div *ngFor="let o of readyOrders" class="bill-request-item" [class.blink]="isNewRequest(o.id)">
        <div class="info">
          <span class="table">{{ o.isTakeaway ? 'Takeaway' : ('Table ' + o.tableNumber) }}</span>
          <span class="amount">{{ o.totalAmount.toFixed(0) }} PKR</span>
          <span class="ago">({{ timeSince(o.createdAt) }})</span>
        </div>
        <div class="actions">
          <button (click)="openSettlement(o)">Open Settlement</button>
        </div>
      </div>
    </div>

    <!-- Settlement Panel -->
    <div class="settlement-panel" *ngIf="selectedBillOrder">
      <button class="panel-close" (click)="cancelSettlement()" aria-label="Close">√ó</button>
      <h2>Payment & Settlement</h2>
      <div class="summary">
        <div><strong>{{ selectedBillOrder.isTakeaway ? 'Takeaway' : ('Table: ' + selectedBillOrder.tableNumber) }}</strong></div>
        <div>Order #: {{ selectedBillOrder.orderNumber }}</div>
        <div class="summary-line">Subtotal: {{ selectedBillOrder.subtotal.toFixed(0) }} PKR</div>
        <div class="summary-line">Tax: {{ selectedBillOrder.tax.toFixed(0) }} PKR</div>
        <div class="summary-line" *ngIf="selectedBillOrder.discount > 0">
          Discount: -{{ selectedBillOrder.discount.toFixed(0) }} PKR
          <span class="discount-label" *ngIf="selectedBillOrder.discountType === 'percentage'">
            ({{ selectedBillOrder.discountValue }}%)
          </span>
        </div>
        <div class="summary-total">
          <span>Total Due: {{ getSelectedBillTotal().toFixed(0) }} PKR</span>
          <!-- Discount Editing (Admin Only) -->
          <button class="btn-edit-discount" *ngIf="authService.hasRole('admin') && !isEditingDiscount" (click)="startEditingDiscount()">
            ‚úèÔ∏è Edit Discount
          </button>
        </div>
      </div>

      <div class="discount-edit-panel" *ngIf="isEditingDiscount">
        <h3>Edit Discount</h3>
        <div class="discount-type-toggle">
          <label>
            <input type="radio" name="discountType" value="fixed" [(ngModel)]="editDiscountType" />
            Fixed Amount
          </label>
          <label>
            <input type="radio" name="discountType" value="percentage" [(ngModel)]="editDiscountType" />
            Percentage
          </label>
        </div>
        
        <div class="discount-value-input">
          <label>
            <span *ngIf="editDiscountType === 'fixed'">Discount Amount (PKR):</span>
            <span *ngIf="editDiscountType === 'percentage'">Discount Percentage (%):</span>
          </label>
          <input 
            type="number" 
            [(ngModel)]="editDiscountValue" 
            [min]="0" 
            [max]="editDiscountType === 'percentage' ? 100 : 999999"
            step="0.01"
            class="discount-input"
          />
        </div>

        <div class="discount-preview">
          <div class="preview-line">Current Total: {{ getSelectedBillTotal().toFixed(0) }} PKR</div>
          <div class="preview-line highlight">New Total: {{ getEditedBillTotal().toFixed(0) }} PKR</div>
          <div class="preview-line savings">
            You Save: {{ (getSelectedBillTotal() - getEditedBillTotal()).toFixed(0) }} PKR
          </div>
        </div>

        <div class="discount-actions">
          <button class="btn btn-secondary" (click)="cancelEditingDiscount()">Cancel</button>
          <button class="btn btn-primary" (click)="applyDiscount()" [disabled]="isLoading">Apply Discount</button>
        </div>
      </div>

      <!-- Payment Method Selection for Bill Settlement -->
      <div class="payment-method-section" *ngIf="!isEditingDiscount">
        <label class="payment-method-label">Payment Method:</label>
        <div class="payment-method-options">
          <label class="payment-option">
            <input type="radio" name="settlementPaymentMethod" value="cash" [(ngModel)]="paymentMethod" />
            <span>üíµ Cash</span>
          </label>
          <label class="payment-option">
            <input type="radio" name="settlementPaymentMethod" value="bank_transfer" [(ngModel)]="paymentMethod" />
            <span>üè¶ Bank Transfer</span>
          </label>
        </div>
      </div>

      <div class="settlement-actions" *ngIf="!isEditingDiscount">
        <button class="details" (click)="viewSelectedBillDetail()">View Order Detail</button>
        <button class="post-to-account" (click)="openCreditCustomerSelection()" [disabled]="isLoading">
          üìù Post to Account
        </button>
        <button class="complete" (click)="completeSettlement()" [disabled]="isLoading">Pay & Print Bill</button>
      </div>
    </div>

    <!-- Credit Customer Selection Modal (Global) -->
    <div class="credit-customer-modal" *ngIf="showCreditCustomerSelection" (click)="closeCreditCustomerSelection()">
      <div class="credit-customer-panel" (click)="$event.stopPropagation()">
        <button class="panel-close" (click)="closeCreditCustomerSelection()" aria-label="Close">√ó</button>
        <h3>Select Credit Customer</h3>
        
        <!-- Search Box -->
        <div class="customer-search">
          <input 
            type="text" 
            [(ngModel)]="creditCustomerSearchText" 
            (input)="filterCreditCustomers()"
            placeholder="üîç Search by name or phone..."
            class="customer-search-input"
          />
        </div>

        <div class="customer-list">
          <div 
            *ngFor="let customer of filteredCreditCustomers" 
            class="customer-option"
            [class.selected]="selectedCreditCustomer?.id === customer.id"
            (click)="selectCreditCustomer(customer)"
          >
            <div class="customer-info">
              <div class="customer-name">{{ customer.name }}</div>
              <div class="customer-phone">{{ customer.phone }}</div>
              <div class="customer-company" *ngIf="customer.companyName">{{ customer.companyName }}</div>
            </div>
            <div class="customer-credit">
              <div class="credit-balance">Balance: {{ customer.currentBalance.toFixed(0) }} PKR</div>
            </div>
          </div>
          <div *ngIf="filteredCreditCustomers.length === 0" class="empty">
            No customers found
          </div>
        </div>
        <div class="credit-actions">
          <button class="btn btn-secondary" (click)="closeCreditCustomerSelection()" [disabled]="isLoading">
            Cancel
          </button>
          <button 
            class="btn btn-primary" 
            (click)="postToAccount()" 
            [disabled]="!selectedCreditCustomer || isLoading"
          >
            Post to Account
          </button>
        </div>
      </div>
    </div>
    
  </div>
</div>

<!-- Bill Preview Modal -->
<div class="modal-overlay" *ngIf="showBillPreviewModal" (click)="closeBillPreview()">
  <div class="modal-content bill-preview-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Bill Preview</h2>
      <button class="close-btn" (click)="closeBillPreview()">√ó</button>
    </div>
    
    <div class="modal-body" *ngIf="previewOrder">
      <!-- Bill Preview Content -->
      <div class="bill-preview-content">
        <div class="restaurant-header">
          <h1>VISAKH</h1>
          <p>Restaurant Bill</p>
        </div>
        
        <div class="bill-divider"></div>
        
        <div class="bill-info">
          <div class="bill-row">
            <span class="label">Order Number:</span>
            <span class="value">{{ previewOrder.orderNumber }}</span>
          </div>
          <div class="bill-row">
            <span class="label">Date & Time:</span>
            <span class="value">{{ formatOrderDate(previewOrder.createdAt) }}</span>
          </div>
          <div class="bill-row">
            <span class="label">Order Type:</span>
            <span class="value">{{ previewOrder.isTakeaway ? 'Takeaway' : 'Dine-in - Table ' + previewOrder.tableNumber }}</span>
          </div>
          <div class="bill-row" *ngIf="previewOrder.customerName">
            <span class="label">Customer:</span>
            <span class="value">{{ previewOrder.customerName }}</span>
          </div>
          <div class="bill-row">
            <span class="label">Payment Method:</span>
            <span class="value">
              {{ previewOrder.paymentMethod === 'cash' ? 'üíµ Cash' : 
                 previewOrder.paymentMethod === 'bank_transfer' ? 'üè¶ Bank Transfer' : 
                 'üìù Credit Account' }}
            </span>
          </div>
        </div>
        
        <div class="bill-divider"></div>
        
        <!-- Items Table -->
        <table class="bill-items-table">
          <thead>
            <tr>
              <th>Item</th>
              <th class="text-center">Qty</th>
              <th class="text-right">Price</th>
              <th class="text-right">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of previewOrder.items">
              <td>{{ item.menuItemName }}</td>
              <td class="text-center">{{ item.quantity }}</td>
              <td class="text-right">{{ item.price.toFixed(0) }}</td>
              <td class="text-right">{{ item.totalPrice.toFixed(0) }}</td>
            </tr>
          </tbody>
        </table>
        
        <div class="bill-divider"></div>
        
        <!-- Totals Section -->
        <div class="bill-totals">
          <div class="total-row">
            <span>Subtotal:</span>
            <span>{{ previewOrder.subtotal.toFixed(0) }} PKR</span>
          </div>
          <div class="total-row">
            <span>Tax:</span>
            <span>{{ previewOrder.tax.toFixed(0) }} PKR</span>
          </div>
          <div class="total-row" *ngIf="previewOrder.discount > 0">
            <span>Discount:</span>
            <span>-{{ previewOrder.discount.toFixed(0) }} PKR</span>
          </div>
          <div class="total-row total-final">
            <span>TOTAL AMOUNT:</span>
            <span>{{ previewOrder.totalAmount.toFixed(0) }} PKR</span>
          </div>
        </div>
        
        <div class="bill-divider"></div>
        
        <div class="bill-footer">
          <p>Thank you for your visit!</p>
          <p>Please visit again</p>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeBillPreview()" [disabled]="isLoading">
        Cancel
      </button>
      <!-- Check if this is a settlement (previewOrder has an id) or new order (no id yet) -->
      <button 
        class="btn btn-warning" 
        (click)="previewOrder?.id ? completeSettlementWithoutPrint() : completeWithoutPrint()" 
        [disabled]="isLoading"
      >
        Complete Payment (No Print)
      </button>
      <button 
        class="btn btn-primary" 
        (click)="previewOrder?.id ? printAndCompleteSettlement() : printAndComplete()" 
        [disabled]="isLoading"
      >
        üñ®Ô∏è Print & Complete
      </button>
    </div>
  </div>
</div>
